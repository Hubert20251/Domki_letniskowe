<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZarzÄ…dzaj WiadomoÅ›ciami</title>
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <header>
        <h1>Panel Administratora</h1>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="admin.html">ZarzÄ…dzaj Rezerwacjami</a></li>
                <li><a href="zarzadzaj_wiadomosciami.html">ZarzÄ…dzaj WiadomoÅ›ciami</a></li>
                <li><a href="zarzadzaj_ofertami.html">ZarzÄ…dzaj Ofertami</a></li>
                <li><a href="zarzadzaj_uzytkownikami.html">ZarzÄ…dzaj UÅ¼ytkownikami</a></li>
                <li><a href="zarzadzaj_opiniami.html">ZarzÄ…dzaj Opiniami</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h2>Lista WiadomoÅ›ci</h2>
        <div id="messages-list">Åadowanie...</div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const user = await checkSession();
            if (!user.loggedIn || user.role !== "admin") {
                alert("Brak uprawnieÅ„! Przekierowanie...");
                window.location.href = "index.html";
                return;
            }
            loadMessages();
        });

        

        async function loadMessages() {
    try {
        const response = await fetch("http://localhost:3000/api/admin/messages", {
            method: "GET",
            credentials: "include"  // WysyÅ‚anie sesji (ciasteczek)
        });

        if (!response.ok) {
            throw new Error("BÅ‚Ä…d serwera: " + response.status);
        }

        const data = await response.json();
        console.log("ğŸ“¥ Pobranie wiadomoÅ›ci:", data);
        
        const list = document.getElementById("messages-list");
        list.innerHTML = "";
        
        data.forEach(msg => {
            const div = document.createElement("div");
            div.classList.add("message-item");
            div.innerHTML = `
                <p><strong>ImiÄ™ i nazwisko:</strong> ${msg.name}</p>
                <p><strong>Email:</strong> ${msg.email}</p>
                <p><strong>WiadomoÅ›Ä‡:</strong> ${msg.message}</p>
                <p><strong>Data:</strong> ${new Date(msg.created_at).toLocaleString()}</p>
                <button onclick="deleteMessage(${msg.id})">ğŸ—‘ï¸ UsuÅ„</button>
                <hr>
            `;
            list.appendChild(div);
        });
    } catch (error) {
        console.error("ğŸš¨ BÅ‚Ä…d wczytywania wiadomoÅ›ci:", error);
        document.getElementById("messages-list").innerText = "Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ wiadomoÅ›ci.";
    }
}


        async function deleteMessage(messageId) {
            if (!confirm("Czy na pewno chcesz usunÄ…Ä‡ tÄ™ wiadomoÅ›Ä‡?")) return;

            try {
                const response = await fetch(`http://localhost:3000/api/admin/messages/${messageId}`, {
                    method: "DELETE"
                });

                if (!response.ok) {
                    throw new Error("BÅ‚Ä…d serwera: " + response.status);
                }
                
                alert("ğŸ—‘ï¸ WiadomoÅ›Ä‡ usuniÄ™ta!");
                loadMessages();
            } catch (error) {
                console.error("âŒ BÅ‚Ä…d usuwania wiadomoÅ›ci:", error);
                alert("âš  WystÄ…piÅ‚ bÅ‚Ä…d usuwania.");
            }
        }
        async function checkSession() {
    try {
        const response = await fetch("http://localhost:3000/api/session");
        if (!response.ok) throw new Error("BÅ‚Ä…d podczas sprawdzania sesji");
        
        const data = await response.json();
        console.log("â„¹ï¸ Dane sesji:", data); // Dodane logowanie

        return data;
    } catch (error) {
        console.error("âŒ BÅ‚Ä…d sprawdzania sesji:", error);
        return { loggedIn: false };
    }
}

    </script>
</body>
</html>
